<!DOCTYPE html>
<head>
    <style>
      body, html {padding: 0; margin: 0; overflow: hidden; height:100%;}
      canvas { z-index: -1;}
      p {color: white; background-color: black;}
      #fps{
        padding: 0; margin: 0;
        width: 60px;
        text-align: center;
      }
      #container {
        position: relative;
        height:100%;
        overflow: hidden;
      }
      #container canvas, #overlay {
        position: absolute;
      }
    </style>
</head>

<body>
  <div id="container">
  <canvas id="canvas"></canvas>
    <p id="fps"></p>
    <p id="time"></p>
  </div>
</body>
<script type="application/x-javascript">
  // utils
  function map(n, start1, stop1, start2, stop2){
    return ((n-start1)/(stop1-start1))*(stop2-start2)+start2;
  }

  function lerp(a, b, n) {
    return (b - a) * n + a;
  }

  function lerpColor(colorA, colorB, amt){
    let r = lerp(colorA.r, colorB.r, amt);
    let g = lerp(colorA.g, colorB.g, amt);
    let b = lerp(colorA.b, colorB.b, amt);
      return 'rgba(' + r +',' + g +','+ b +',1)';
  }

  function color(x){
    return 'rgba(' + x.r +',' + x.g +','+ x.b +',1)'
  }

  function constrain(x, min, max){
    x = Math.max(x, min);
    x = Math.min(x, max);
    return x;
  }

</script>
<script type="application/javascript">
    let canvas = document.getElementById("canvas");
    let c = canvas.getContext("2d");
    let width, height;
    let frameCount = 0;
    let colorBackground = {
      r: 12,
      g: 40,
      b: 132
    }
    let colorForeground = {
      r: 255,
      g: 255,
      b: 255
    }

    function updateCanvasSize(){
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }


    function update(time){
      document.getElementById("fps").innerHTML = averageFps();
      frameCount++;
      time *= 0.0005;
      updateCanvasSize();
      c.resetTransform();
      c.clearRect(0,0,width,height);
      c.fillStyle = color(colorBackground);
      c.fillRect(0,0, width, height);
      drawInnerMandala(time);
      requestAnimationFrame(update);
    }

    var historicalFps = [];
    var lastLoop = new Date();
    function averageFps(){
      var thisLoop = new Date();
      var fps = 1000 / (thisLoop - lastLoop);
      fps = constrain(fps, 0, 200);
      lastLoop = thisLoop;
      let averagingRange = 120;
      historicalFps.push(fps);
      if(historicalFps.length > averagingRange){
        historicalFps.shift();
      }
      let sum = 0;
      historicalFps.forEach((item) => {
        sum += item;
      });
      let avg = sum / historicalFps.length;
      return Math.round(avg) + " fps";
    }

    function drawInnerMandala(time){
      let count = 50;
      let maxSize = 200;
      for(let i = 1; i < count; i++){
        setTransform(c, width / 2, height / 2);
        let iNorm = map(i, 1, count-1, 0, 1);
        c.rotate(Math.PI / 4 + iNorm * Math.PI * 6 * (Math.cos(time)));
        let size = maxSize-iNorm*maxSize;
        c.strokeStyle = color(colorForeground);
        c.fillStyle = lerpColor(colorBackground, colorForeground, Math.pow(iNorm, 0.9));
        c.beginPath();

        c.lineWidth = 3+iNorm*5;
        c.lineTo(size, 0);
        c.fillRect(-size,-size, size*2, size*2);
        c.strokeRect(-size,-size, size*2, size*2);
        c.fill();
        c.stroke();
      }
      c.resetTransform();
    }

    function setTransform(c, x, y){
      c.setTransform(1, 0, 0, 1, x, y);
    }
    requestAnimationFrame(update);

</script>
